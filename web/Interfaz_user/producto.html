<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Producto | Agroinsumos San Pedro</title>
    <link rel="stylesheet" href="css/estiloproducto.css">
</head>

<body>



    <!-- HEADER -->
    <header class="Header">
        <a href="index.html" class="logo">
            <img src="imgs/logo.png" alt="Logotipo de Agroinsumos San Pedro" class="logo__img" />
        </a>


        <div class="buscador__contenedor">
            <input id="input-busqueda" type="text" placeholder="Te ayudamos a encontrar el producto ideal..."
                class="buscador__input" />

            <img id="btn-buscar-ia" src="imgs/lupa.png" alt="Buscar" class="buscador__icono">

        </div>

        <div class="botones-derecha">
            <button class="carrito-de-compras" onclick="window.location.href='favoritos.html'">
                <img src="imgs/favs.png">
            </button>
            <button class="carrito-de-compras" onclick="window.location.href='carrito.html'">
                <img src="imgs/carrito.png">
            </button>
            <button class="btn-login" onclick="window.location.href='login.html'">Iniciar sesi칩n</button>
            <button class="btn-registrarse" onclick="window.location.href='registro.html'">Registrarse</button>
        </div>
    </header>

    <!-- CONTENIDO PRINCIPAL -->
    <main>
        <div class="producto-detalle" id="productos">

            <div class="tarjeta-producto">
                <img src="" alt="Producto" id="img-producto">
                <h3 id="nombre-producto"></h3>
            </div>

            <div class="info-producto" id="info-producto"></div>

        </div>

        <!-- BOT칍N VOLVER -->
        <div class="volver">
            <a href="catalogo.html" class="btn volver-btn">Volver</a>
        </div>
    </main>

    <!-- FOOTER -->
    <footer class="footer">
        <h2>Agroinsumos San Pedro</h2>
        <p>Todos los derechos reservados 춸 2025</p>
    </footer>

    <!-- L칍GICA DEL PRODUCTO -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {

            const producto = JSON.parse(localStorage.getItem("productoSeleccionado"));

            if (!producto) {
                alert("No se pudo cargar el producto.");
                return window.location.href = "catalogo.html";
            }

            // Insertar datos
            document.getElementById("img-producto").src = producto.direccion_img || "imgs/ingrediente.png";
            document.getElementById("nombre-producto").innerText = producto.nombre_producto;

            document.getElementById("info-producto").innerHTML = `
                <p>游꺟 <strong>Descripci칩n:</strong> ${producto.descripcion}</p>
                <p>游빖 <strong>Categor칤a:</strong> ${producto.categoria_producto}</p>
                <p>游뚶 <strong>Ingrediente Activo:</strong> ${producto.ingrediente_activo}</p>
                <p><strong>Cantidad disponible:</strong> ${producto.cantidad}</p>
                <p><strong>Precio:</strong> $${producto.precio}</p>

                <div class="acciones-producto">
                    <div class="botones-acciones">
                        <button id="btn-carrito" class="btn">Agregar al carrito</button>
                        <button id="btn-fav" class="btn">Agregar a favoritos</button>
                    </div>
                    <button id="btn-comprar" class="btn comprar">Comprar ahora</button>
                </div>
            `;

            // Funci칩n para agregar al carrito
            function agregarAlCarrito(prod) {
                const usuarioId = localStorage.getItem("usuarioId");
                let carrito = JSON.parse(localStorage.getItem(`carrito_${usuarioId}`)) || [];

                const existe = carrito.find(p => p.id_producto === prod.id_producto);

                if (existe) {
                    existe.cantidad++;
                } else {
                    carrito.push({
                        id_producto: prod.id_producto,
                        nombre: prod.nombre_producto,
                        precio: prod.precio,
                        cantidad: 1,
                        imagen: prod.direccion_img || "imgs/ingrediente.png"
                    });
                }

                localStorage.setItem(`carrito_${usuarioId}`, JSON.stringify(carrito));
            }

            // Bot칩n Agregar al carrito
            document.getElementById("btn-carrito").addEventListener("click", () => {
                agregarAlCarrito(producto);
                window.location.href = "carrito.html";
            });

            // Bot칩n Comprar
            document.getElementById("btn-comprar").addEventListener("click", () => {
                agregarAlCarrito(producto);
                window.location.href = "pago.html";
            });

            // Bot칩n Favoritos
            document.getElementById("btn-fav").addEventListener("click", async () => {

                const usuarioId = localStorage.getItem("usuarioId");
                if (!usuarioId) {
                    alert("Inicia sesi칩n para guardar favoritos.");
                    return window.location.href = "login.html";
                }

                const resp = await fetch("https://agroinsumos-san-pedro-despliegue-us-seven.vercel.app", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ usuarioId, productoId: producto.id_producto })
                });

                const data = await resp.json();

                if (resp.ok) {
                    alert("Producto agregado 仇벒잺");
                    window.location.href = "favoritos.html";
                } else {
                    alert("Error: " + data.error);
                }
            });

        });


        /* ============================================================
   BUSCADOR INTELIGENTE CON IA PARA REDIRECCI칍N DE CATEGOR칈AS
   ============================================================ */

        const API_KEY = "AIzaSyBysGS4NIAyd6Wvk2E42QRgcsDEgge71iw";
        const MODEL = "gemini-2.0-flash";

        const URL_GEMINI = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`;

        document.getElementById("btn-buscar-ia").addEventListener("click", interpretarBusqueda);
        document.getElementById("input-busqueda").addEventListener("keypress", e => {
            if (e.key === "Enter") interpretarBusqueda();
        });

        async function interpretarBusqueda() {
            const texto = document.getElementById("input-busqueda").value.trim();

            if (!texto) {
                alert("Por favor escribe lo que deseas buscar.");
                return;
            }

            // Muestra estado opcional
            console.log("Consultando IA para:", texto);

            const prompt = `
    Eres un sistema de b칰squeda de una tienda de agroinsumos.
    El usuario escribi칩: "${texto}".

    Tu trabajo es identificar a qu칠 categor칤a pertenece.

    Las 칰nicas categor칤as v치lidas son exactamente estas:
    - SEMILLAS
    - FERTILIZANTES
    - PLAGUICIDAS
    - HERBICIDAS
    - FUNGICIDAS

    Devuelve SOLO un objeto JSON con este formato exacto:

    {
      "categoria": "..."
    }

    Donde "categoria" debe ser una de las categor칤as listadas arriba.
    No devuelvas explicaciones, no devuelvas texto extra.
  `;

            try {
                const response = await fetch(URL_GEMINI, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: {
                            temperature: 0.2,
                            responseMimeType: "application/json"
                        }
                    })
                });

                const data = await response.json();
                console.log("Respuesta IA:", data);

                const textResult = data?.candidates?.[0]?.content?.parts?.[0]?.text;

                const json = JSON.parse(textResult);

                const categoria = json.categoria;

                if (!categoria) {
                    alert("No se pudo identificar la categor칤a.");
                    return;
                }

                // URL de tu cat치logo (PROYECTO DEPLOYADO EN VERCEL)
                const URL_BASE = "https://agroinsumos-san-pedro-despliegue-us-tau.vercel.app";

                const destino = `${URL_BASE}/inven.html?categoria=${categoria}`;

                console.log("Redirigiendo a:", destino);
                window.location.href = destino;

            } catch (error) {
                console.error("Error con IA:", error);
                alert("Ocurri칩 un error al procesar la b칰squeda.");
            }
        }
    </script>

</body>

</html>

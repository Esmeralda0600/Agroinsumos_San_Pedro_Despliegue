<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Producto | Agroinsumos San Pedro</title>
    <link rel="stylesheet" href="css/estiloproducto.css">
</head>

<body>

    <!-- ==================== HEADER ==================== -->
    <header class="Header">

        <!-- Logo -->
        <a href="index.html" class="logo">
            <img src="imgs/logo.png" alt="Logotipo de Agroinsumos San Pedro" class="logo__img" />
        </a>

        <!-- Buscador -->
        <div class="buscador__contenedor">
            <input id="input-busqueda" type="text" placeholder="Te ayudamos a encontrar el producto ideal..."
                class="buscador__input" />
            <img id="btn-buscar-ia" src="imgs/lupa.png" alt="Buscar" class="buscador__icono">
        </div>

        <!-- Botones derecha / login dinÃ¡mico -->
        <div class="botones-derecha">

            <button class="carrito-de-compras" onclick="window.location.href='favoritos.html'">
                <img src="imgs/favs.png">
            </button>

            <button class="carrito-de-compras" onclick="window.location.href='carrito.html'">
                <img src="imgs/carrito.png">
            </button>

            <!-- Login -->
            <button id="btn-login" class="btn-login" onclick="window.location.href='login.html'">
                Iniciar sesiÃ³n
            </button>

            <!-- Registro -->
            <button id="btn-register" class="btn-registrarse" onclick="window.location.href='registro.html'">
                Registrarse
            </button>

            <!-- Icono usuario -->
            <button id="btn-user" class="icono-user" style="display:none;">
                <img src="imgs/usuario.png" alt="Usuario">
            </button>

            <!-- Cerrar sesiÃ³n -->
            <button id="btn-logout" class="btn-registrarse" style="display:none;">
                Cerrar sesiÃ³n
            </button>
        </div>

    </header>

    <!-- ==================== DETALLE DEL PRODUCTO ==================== -->
    <main>
        <div class="producto-detalle" id="productos">

            <div class="tarjeta-producto">
                <img src="" alt="Producto" id="img-producto">
                <h3 id="nombre-producto"></h3>
            </div>

            <div class="info-producto" id="info-producto"></div>

        </div>

        <div class="volver">
            <a href="catalogo.html" class="btn volver-btn">Volver</a>
        </div>
    </main>

    <!-- ==================== FOOTER ==================== -->
    <footer class="footer">
        <h2>Agroinsumos San Pedro</h2>
        <p>Todos los derechos reservados Â© 2025</p>
    </footer>

    <!-- ==================== LÃ“GICA DEL PRODUCTO ==================== -->
    <script>
document.addEventListener("DOMContentLoaded", async () => {

    const API_URL = "https://agroinsumos-san-pedro-despliegue.onrender.com";

    const producto = JSON.parse(localStorage.getItem("productoSeleccionado"));

    if (!producto) {
        alert("No se pudo cargar el producto.");
        return window.location.href = "catalogo.html";
    }

    // Insertar datos del producto
    document.getElementById("img-producto").src = producto.direccion_img || "imgs/ingrediente.png";
    document.getElementById("nombre-producto").innerText = producto.nombre_producto;

    document.getElementById("info-producto").innerHTML = `
        <p>ðŸŒ½ <strong>DescripciÃ³n:</strong> ${producto.descripcion}</p>
        <p>ðŸ§´ <strong>CategorÃ­a:</strong> ${producto.categoria_producto}</p>
        <p>ðŸšœ <strong>Ingrediente Activo:</strong> ${producto.ingrediente_activo}</p>
        <p><strong>Cantidad disponible:</strong> ${producto.cantidad}</p>
        <p><strong>Precio:</strong> $${producto.precio}</p>

        <div class="acciones-producto">
            <div class="botones-acciones">
                <button id="btn-carrito" class="btn">Agregar al carrito</button>

                <!-- CORAZÃ“N PNG -->
                <img id="btn-fav-icono"
                     src="imgs/corazon_vacio.png"
                     class="btn-favorito"
                     style="width:45px;cursor:pointer;margin-top:10px;">
            </div>

            <button id="btn-comprar" class="btn comprar">Comprar ahora</button>
        </div>
    `;


    /* ============================================================
            ðŸŸ¢ FAVORITOS SINCRONIZADOS (igual que inven.html)
       ============================================================ */

    // Actualiza el Ã­cono dependiendo si estÃ¡ o no en favoritos LS
    function actualizarIconoFavorito() {
        const favsLS = JSON.parse(localStorage.getItem("favoritosLS")) || [];
        const btnFav = document.getElementById("btn-fav-icono");

        if (favsLS.includes(producto.nombre_producto)) {
            btnFav.src = "imgs/corazon_lleno.png";
            btnFav.classList.add("favorito-activo");
        } else {
            btnFav.src = "imgs/corazon_vacio.png";
            btnFav.classList.remove("favorito-activo");
        }
    }

    async function toggleFavoritoDetalle() {
        const usuarioId = localStorage.getItem("usuarioId");
        if (!usuarioId) {
            alert("Debes iniciar sesiÃ³n para gestionar favoritos.");
            return window.location.href = "login.html";
        }

        let favsLS = JSON.parse(localStorage.getItem("favoritosLS")) || [];
        const btnFav = document.getElementById("btn-fav-icono");
        const yaEsta = favsLS.includes(producto.nombre_producto);

        // =========================
        // âŒ SI YA ESTÃ â†’ QUITAR
        // =========================
        if (yaEsta) {
            favsLS = favsLS.filter(n => n !== producto.nombre_producto);
            localStorage.setItem("favoritosLS", JSON.stringify(favsLS));

            // Eliminar del backend
            try {
                const resp = await fetch(`${API_URL}/favoritos/${usuarioId}`);
                const data = await resp.json();

                const favorito = data.favoritos.find(f =>
                    f.producto?.id_producto === producto.id_producto
                );

                if (favorito) {
                    await fetch(`${API_URL}/favoritos/${favorito._id}`, {
                        method: "DELETE"
                    });
                }
            } catch (err) {
                console.error("Error eliminando favorito backend:", err);
            }

            actualizarIconoFavorito();
            return;
        }

        // =========================
        // â¤ï¸ SI NO ESTÃ â†’ AGREGAR
        // =========================
        favsLS.push(producto.nombre_producto);
        localStorage.setItem("favoritosLS", JSON.stringify(favsLS));

        // backend
        await fetch(`${API_URL}/favoritos`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ usuarioId, productoId: producto.id_producto })
        });

        actualizarIconoFavorito();
    }

    document.getElementById("btn-fav-icono")
        .addEventListener("click", toggleFavoritoDetalle);

    actualizarIconoFavorito();



    /* ============================================================
                            CARRITO
       ============================================================ */
    function agregarAlCarrito(prod) {
        const usuarioId = localStorage.getItem("usuarioId");

        if (!usuarioId) {
            alert("Inicia sesiÃ³n para agregar al carrito.");
            return window.location.href = "login.html";
        }

        const claveCarrito = `carrito_${usuarioId}`;
        let carrito = JSON.parse(localStorage.getItem(claveCarrito)) || [];

        const existe = carrito.find(p => p.id_producto === prod.id_producto);

        if (existe) {
            existe.cantidad++;
        } else {
            carrito.push({
                id_producto: prod.id_producto,
                nombre: prod.nombre_producto,
                precio: prod.precio,
                cantidad: 1,
                imagen: prod.direccion_img || "imgs/ingrediente.png"
            });
        }

        localStorage.setItem(claveCarrito, JSON.stringify(carrito));
    }

    document.getElementById("btn-carrito").addEventListener("click", () => {
        agregarAlCarrito(producto);
        window.location.href = "carrito.html";
    });


    /* ============================================================
                        COMPRAR AHORA
       ============================================================ */
    document.getElementById("btn-comprar").addEventListener("click", () => {
        const usuarioId = localStorage.getItem("usuarioId");

        if (!usuarioId) {
            alert("Debes iniciar sesiÃ³n para comprar.");
            return window.location.href = "login.html";
        }

        const item = {
            id_producto: producto.id_producto,
            nombre: producto.nombre_producto,
            precio: producto.precio,
            cantidad: 1,
            imagen: producto.direccion_img || "imgs/ingrediente.png"
        };

        localStorage.setItem("modo_compra", "directa");
        localStorage.setItem("compra_directa", JSON.stringify([item]));

        window.location.href = "pago.html";
    });

});
</script>


    <!-- ==================== BUSCADOR IA ==================== -->
    <script>
        const IA_URL = "https://agroinsumos-san-pedro-despliegue.onrender.com/api/ia/interpretar";

        document.getElementById("btn-buscar-ia").addEventListener("click", interpretarBusqueda);
        document.getElementById("input-busqueda").addEventListener("keypress", e => {
            if (e.key === "Enter") interpretarBusqueda();
        });

        async function interpretarBusqueda() {
            const texto = document.getElementById("input-busqueda").value.trim();

            if (!texto) {
                alert("Por favor escribe lo que deseas buscar.");
                return;
            }

            try {
                const response = await fetch(IA_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ texto })
                });

                const data = await response.json();
                const categoria = data.categoria;

                if (!categoria) {
                    alert("No se pudo identificar la categorÃ­a.");
                    return;
                }

                const URL_BASE = "https://agroinsumos-san-pedro-despliegue-us-eight.vercel.app";
                const destino = `${URL_BASE}/inven.html?categoria=${categoria}`;

                window.location.href = destino;

            } catch (error) {
                console.error("Error con IA:", error);
                alert("OcurriÃ³ un error al procesar la bÃºsqueda.");
            }
        }
    </script>

    <!-- LOGIN DINÃMICO -->
    <script type="module" src="javascript/logica.js"></script>
    <script src="javascript/auth.js"></script>

</body>

</html>
